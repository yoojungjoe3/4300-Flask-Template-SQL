<!doctype html>
<title>{% block title %}{% endblock %} - Flaskr</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap" rel="stylesheet">

<body style="background-color: #758e89;">
  <div class="full-body-container">
    <div class="top-text">
      <div class="google-colors">
        <div style="position: relative; display: inline-block;">
          <img src="{{ url_for('static', filename='images/title_gif.gif') }}" alt="QuillQuest Logo" style="position: relative; z-index: 1; width: 400px; height: auto;" />
        </div>
      </div>
      <div class="input-box">
        <img src="{{ url_for('static', filename='images/search2.png') }}" />
        <input name="Name" placeholder="Search 'Harry Potter' or 'Dramione'..." id="filter-text-val" style="font-family: 'Courier New', monospace; background-color:white;">
        <button style="font-family: 'Courier New', monospace; background-color: grey;color: white;" onclick="filterText()">Search</button>
      </div>
    </div>
    <div id="answer-box"></div>
  </div>

  <script>
    function answerBoxTemplate(name, ship, fandom, rating, abstract, link, image, index) {
      return `
        <div style="border: 1px solid #ccc; border-radius: 10px; padding: 16px; margin: 20px auto; background-color: #f9f9f9; font-family: Arial, sans-serif; width: 100%;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">${name}</h2>
            <span style="border: 2px solid #444; background-color: #eee; padding: 4px 8px; border-radius: 6px; font-size: 14px;">Rating: ${rating}</span>
          </div>
          <p>${fandom} | ${ship}</p>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <img src="${image}" style="max-width: 100px;" />
            <span style="font-size: 14px; padding: 4px 8px;">${abstract}<br><a href=${link}>Press Here to Start Reading!</a></span>
          </div>
          <div style="margin-top: 10px;">
            <button onclick="submitFeedback(${index}, 1)" style="margin-right: 10px;">üëç Like</button>
            <button onclick="submitFeedback(${index}, -1)">üëé Dislike</button>
          </div>
        </div>`;
    }

    function filterText() {
      document.getElementById("answer-box").innerHTML = "";
      const searchText = document.getElementById("filter-text-val").value;

      fetch("/fics?" + new URLSearchParams({ Name: searchText }).toString())
        .then(response => response.json())
        .then(data => {
          if (data.ourentries && data.ourentries.length === 0) {
            document.getElementById("answer-box").innerHTML = "<p>No Fanfics Match Your Query :(</p>";
          } else {
            data.ourentries.forEach((entry, index) => {
              const html = answerBoxTemplate(entry.name, entry.ship, entry.fandom, entry.rating, entry.abstract, entry.link, entry.image, index);
              document.getElementById("answer-box").innerHTML += html;
            });
          }
        })
        .catch(error => {
          console.error("Fetch error:", error);
          document.getElementById("answer-box").innerHTML = `<p>Error: ${error.message}</p>`;
        });
    }

    function submitFeedback(index, feedback) {
      fetch('/submit_feedback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ feedback: [{ doc_index: index, feedback: feedback }] })
      })
      .then(response => response.json())
      .then(data => console.log("Feedback submitted:", data))
      .catch(error => console.error("Feedback error:", error));
    }
  </script>
</body>